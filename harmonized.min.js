!function(a,b){"function"==typeof define&&define.amd?define([],b):a.libGlobalName=b()}(this,function(){var a,b,c;!function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){var c=v.call(arguments,0);return"string"!=typeof c[0]&&1===c.length&&c.push(null),n.apply(d,c.concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("../bower_components/almond/almond",function(){}),c("harmonizedData",["lodash"],function(a){var b={};return b._config={defaultKeys:{serverKey:"id",storeKey:"_id"},baseUrl:null,dbName:"harmonizedDb",sendModifiedSince:!1,fetchAtStart:!1,saveLocally:!1,serverOptions:{protocol:"http"}},b._resourceSchema={},b._httpFunction=function(){throw new Error("No http function was added")},b._viewUpdateCb=function(){},b.dbVersion=1,b.setModelSchema=function(a){b._setModelSchema(a),b._modelSchema=a},b.getModelSchema=function(){return b._modelSchema},b._setModelSchema=function(c,d){var e,f,g;for(var h in c){if(f=c[h],a.isObject(f.keys))g=f.keys,a.isUndefined(g.serverKey)&&(g.serverKey=this._config.defaultKeys.serverKey),a.isUndefined(g.storeKey)&&(g.storeKey=this._config.defaultKeys.storeKey);else{var i=a.clone(this._config.defaultKeys);f.keys=i}a.isUndefined(f.storeName)&&(a.isString(d)||(d=""),f.storeName=d+h),a.isUndefined(f.route)&&(f.route=h),a.isUndefined(f.baseUrl)&&(f.baseUrl=b._config.baseUrl),a.isUndefined(f.saveLocally)&&(f.saveLocally=b._config.saveLocally),a.isUndefined(f.serverOptions)&&(f.serverOptions=a.clone(b._config.serverOptions)),a.isUndefined(f.fetchAtStart)&&(f.fetchAtStart=b._config.fetchAtStart),e=f.subModels,a.isObject(e)&&b._setModelSchema(e,f.storeName+"_")}},b.getDbSchema=function(){var a={};return b._getDbSchema(b._modelSchema,a),a},b._getDbSchema=function(c,d){var e,f;for(var g in c)e=c[g],d[e.storeName]=e.keys,f=c[g].subModels,a.isObject(f)&&b._getDbSchema(f,d)},b._createStreamItem=function(b,c){b=a.clone(b)||{};var d={meta:{storeId:b[c.storeKey],serverId:b[c.serverKey],deleted:!!b._deleted}};return a.isUndefined(c.storeKey)&&delete d.meta.storeId,delete b[c.storeKey],delete b[c.serverKey],delete b._deleted,d.data=b,d},b}),c("ServerHandler/httpHandler",["harmonizedData","lodash"],function(a,b){return{connect:function(a){a._connected=!0,a.pushAll()},disconnect:function(a){a._connected=!1},fetch:function(c,d){var e={};b.isObject(c._options.params)&&(e.params=c._options.params),a._config.sendModifiedSince&&c._lastModified>0&&(e.headers={"If-Modified-Since":c._lastModified}),e.url=c._fullUrl,e.method="GET",a._httpFunction(e).then(function(e){c._lastModified=e.header.lastModified;for(var f=e.data,g=f.length,h=0;g>h;h++){var i=a._createStreamItem(f[h],{serverKey:c._keys.serverKey});i.meta.action="save",c.downStream.onNext(i)}b.isFunction(d)&&d()})["catch"](function(a){c._broadcastError(a)})},sendRequest:function(b,c){return b.url=c._fullUrl,b.method=b.method||"GET",a._httpFunction(b)},push:function(c,d){var e={};b.isObject(d._options.params)&&(e.params=d._options.params),e.url=d._fullUrl;var f=c.meta.action;switch(f){case"save":e.data=c.data,b.isUndefined(c.meta.serverId)?e.method="POST":(e.method="PUT",e.url=e.url+c.meta.serverId+"/");break;case"delete":e.method="DELETE",e.url=e.url+c.meta.serverId+"/";break;case"function":e.method="POST";var g=b.isUndefined(c.meta.serverId)?"":c.meta.serverId+"/";e.url=e.url+g+c.data.fnName+"/",e.data=c.data.fnArgs}a._httpFunction(e).then(function(e){var f=a._createStreamItem(e.data,{serverKey:d._keys.serverKey});c.meta.serverId=f.meta.serverId||c.meta.serverId,b.isUndefined(c.meta.serverId)&&delete c.meta.serverId,"delete"===c.meta.action?(c.meta.action="deletePermanently",c.meta.deleted=!0):"function"===c.meta.action&&(c.data.fnReturn=f.data),d.downStream.onNext(c)})["catch"](function(a){d._unpushedList[c.meta.rtId]=c,d._broadcastError(a)})}}}),c("ServerHandler/socketHandler",["harmonizedData"],function(){return{connect:function(){},disconnect:function(){},fetch:function(){},push:function(){}}}),c("helper/webStorage",[],function(){var a={};return a.getWebStorage=function(){return a._webStorage},a._getLocalStorage=function(){return window.localStorage},a._getSessionStorage=function(){return window.sessionStorage},a._webStorage=a._getSessionStorage(),a.setWebStorage=function(b,c){switch(c&&a._webStorage.clear(),b){case"session":a._webStorage=a._getSessionStorage();break;case"local":a._webStorage=a._getLocalStorage();break;default:a._webStorage=a._getSessionStorage()}},a}),c("ServerHandler",["ServerHandler/httpHandler","ServerHandler/socketHandler","helper/webStorage","rx"],function(a,b,c,d){var e=function(a,b,f){var g=this;this._baseUrl=a.splice(0,1)[0],this._resourcePath=a,this._fullUrl=this._buildUrl(),this._options=f||{},this._keys=b,this.upStream=new d.Subject,this.upStream.subscribe(function(a){g._connected?g._protocol.push(a,g):g._unpushedList[a.meta.rtId]=a},function(){}),this.downStream=new d.Subject,this.downStream.subscribe(function(){},function(a){e.errorStream.onNext(a)}),this.connectionStream=new d.Subject,this.connectionStream.subscribe(function(a){g.setConnectionState(a)}),this._connected=!1,e.connectionStream.subscribe(this.connectionStream),this._unpushedList={},this._lastModified=c.getWebStorage().getItem("harmonized-modified-"+this._resourcePath.join("_"))||0,this._protocol=null;var h;h="websocket"===this._options.protocol?"websocket":"http",this._setProtocol(h)};return e.connectionStream=new d.Subject,e.errorStream=new d.Subject,e.prototype._setProtocol=function(c){function d(a){null!==e._protocol&&e._protocol.disconnect(e),e._protocol=a,e._protocol.connect(e)}var e=this;"http"===c&&this._protocol!==a?d(a):"websocket"===c&&this._protocol!==b&&d(b)},e.prototype.fetch=function(a){this._protocol.fetch(this,a)},e.prototype.sendHttpRequest=function(b){return a.sendRequest(b,this)},e.prototype.pushAll=function(){for(var a in this._unpushedList)this.upStream.onNext(this._unpushedList[a]),delete this._unpushedList[a]},e.prototype.setConnectionState=function(a){this._connected!==a&&(a?this._protocol.connect(this):this._protocol.disconnect(this))},e.prototype._broadcastError=function(a){e.errorStream.onNext(a)},e.prototype._createServerItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._keys.serverKey]=a.meta.serverId),b},e.prototype._buildUrl=function(){for(var a=this._baseUrl+"/",b=0;b<this._resourcePath.length;b++)a=a+this._resourcePath[b]+"/";return a},e.prototype.setLastModified=function(a){this._lastModified=a;var b=this._resourcePath.join("_");c.getWebStorage().setItem("harmonized-modified-"+b,a)},e}),c("DbHandler/BaseHandler",["helper/webStorage"],function(a){var b=function(b,c,d){var e=this;this._storeName=c,this._keys=d,this.downStream=new Rx.Subject,this.upStream=new Rx.Subject,this._upStream=this.upStream.pausableBuffered(b._connectionStream),b._db||b._isConnecting!==!1||(b._connectionStream.onNext(!1),b.connect()),this._saveUpstream=this._upStream.filter(function(a){return"save"===a.meta.action}),this._saveDownstream=this._saveUpstream.flatMap(function(a){return e.put(a)}),this._saveSubscribe=this._saveDownstream.subscribe(this.downStream),this._deleteUpstream=this._upStream.filter(function(a){return"delete"===a.meta.action}),this._deleteDownstream=this._deleteUpstream.flatMap(function(a){return _.isUndefined(a.meta.serverId)?e.remove(a):e.put(a)}),this._deleteSubscribe=this._deleteDownstream.subscribe(this.downStream),this._deletePermanentlyUpstream=this._upStream.filter(function(a){return"deletePermanently"===a.meta.action}),this._deletePermanentlyDownstream=this._deletePermanentlyUpstream.map(function(a){return e.remove(a),a}),this._deletePermanentlySubscribe=this._deletePermanentlyDownstream.subscribe(this.downStream),this._metaStorageName="harmonized-meta-"+this._storeName,this._metadata=a.getWebStorage().getItem(this._metaStorageName)||{}};return b.prototype.getMetadata=function(){return this._metadata},b.prototype.setMetadata=function(b,c){this._metadata[b]=c,a.getWebStorage().setItem(this._metaStorageName,this._metadata)},b.prototype._createDbItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.storeId)||(b[this._keys.storeKey]=a.meta.storeId),_.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._keys.serverKey]=a.meta.serverId),b._deleted=_.isUndefined(a.meta)||"delete"!==a.meta.action?!1:!0,b},b}),c("DbHandler/IndexedDbHandler",["DbHandler/BaseHandler","harmonizedData","rx","lodash"],function(a,b,c,d){var e=function f(b,c){this._handlerType="IndexedDB",a.call(this,f,b,c)};return e._connectionStream=new c.Subject,e._db=null,e._isConnecting=!1,e.getDbReference=function(){return window.indexedDB},e.connect=function(){var a=e;if(null!==a._db||a._isConnecting)return void(a._isConnecting=!1);a._isConnecting=!0;var c=a.getDbReference().open("harmonizedDb",b.dbVersion);return c.onsuccess=function(){a._db=c.result,a._isConnecting=!1,a._connectionStream.onNext(!0)},c.onerror=function(b){a._connectionStream.onError(new Error(b.target.error.name)),a._isConnecting=!1},c.onupgradeneeded=function(a){var c,e,f=a.target.result,g=b.getDbSchema();if(!d.isUndefined(f))for(e=f.objectStoreNames.length-1;e>=0;e--)c=f.objectStoreNames[e],f.deleteObjectStore(c);for(var h in g){c=g[h];var i=f.createObjectStore(h,{keyPath:c.storeKey,autoIncrement:!0});i.createIndex("serverId",c.serverKey,{unique:!0,multiEntry:!1})}},c},e.closeConnection=function(){var a=e,b=a._db;b&&(b.close(),a._db=null,a._connectionStream.onNext(!1))},e.deleteDb=function(){return e.closeConnection(),e.getDbReference().deleteDatabase("harmonizedDb")},e.prototype=Object.create(a.prototype),e.prototype.getAllEntries=function(a){var c=this,f=e._db.transaction([c._storeName]).objectStore(c._storeName),g=f.openCursor();g.onsuccess=function(e){if(g=e.target.result){var f=g.value,h=b._createStreamItem(f,c._keys);h.meta.action=h.meta.deleted?"delete":"save",c.downStream.onNext(h),g["continue"]()}else d.isFunction(a)&&a()},g.onerror=c.downStream.onError},e.prototype.getEntry=function(a){var c=this,f=e._db.transaction([c._storeName]),g=f.objectStore(c._storeName),h=g.get(a);h.onerror=c.downStream.onError,h.onsuccess=function(){if(d.isUndefined(h.result))c.downStream.onError(new Error("Item with id "+a+" not found in database"));else{var e=b._createStreamItem(h.result,c._keys);c.downStream.onNext(e)}}},e.prototype.put=function(a){function b(c){if(c&&(d.isUndefined(a[j].meta)&&(a[j].meta={}),a[j].meta.storeId=c.target.result,h.onNext(a[j]),j++),j<a.length){var e=i._createDbItem(a[j]),g=l.put(e);g.onsuccess=b,g.onerror=f}else h.onCompleted()}function f(){j++,b()}var g=e,h=new c.Subject;if(!g._db)return h.onError(new Error("no database connection established")),h.onCompleted(),h;var i=this,j=0;d.isArray(a)||(a=[a]);var k=g._db.transaction([i._storeName],"readwrite");k.onerror=function(a){h.onError(new Error(a.target.error.name))};var l=k.objectStore(i._storeName);return b(),h},e.prototype.remove=function(a){var b=e,d=this,f=new c.Subject;if(!b._db)return f.onError(new Error("no database connection established")),f.onCompleted(),f;var g=b._db.transaction([d._storeName],"readwrite").objectStore(d._storeName)["delete"](a.meta.storeId);return g.onsuccess=function(){a.meta.deleted=!0,a.meta.action="deletePermanently",f.onNext(a),f.onCompleted()},g.onerror=f.onError,f},e}),c("DbHandler/WebSqlHandler",["DbHandler/BaseHandler"],function(){var a=function(){};return a}),c("dbHandlerFactory",["harmonizedData","DbHandler/IndexedDbHandler","DbHandler/WebSqlHandler"],function(a,b,c){var d=function e(){e._DbHandler=e._getIndexedDb()?b:e._getWebSql()?c:void 0};return d.createDbHandler=function(a,b){return d._DbHandler?new d._DbHandler(a,b):void 0},d._getIndexedDb=function(){return window.indexedDB&&_.isFunction(b)?window.indexedDB:null},d._getWebSql=function(){return window.openDatabase&&_.isFunction(c)?window.openDatabase:null},d(),d}),c("SubModel",["harmonizedData","ServerHandler","dbHandlerFactory","modelHandler","lodash"],function(a,b,c,d,e){function f(a,b,c){e.isUndefined(a[b])&&(a[b]=c[b])}var g=function(a,g,h){var i=this;i._modelName=a,i._options=h||{},i.getParent=function(){return g},i._gotServerData=!1,i._gotDbData=!1;var j=g.getModel(),k=j._subModelsSchema[a],l=i._options;f(l,"route",k),f(l,"keys",k),f(l,"storeName",k),i._model=d.getModel(k.sourceModel),e.isUndefined(l.serverOptions)&&(l.serverOptions={}),i._serverHandler=new b(i.getFullRoute(),l.serverOptions),i._dbHandler=c.createDbHandler(l.storeName,l.keys),i._serverHandler.downStream.subscribe(function(a){var b=a.meta.serverId,c=a.meta.action;if(e.isUndefined(b))i._serverItems=a.data,i._gotServerData=!0,i._gotDbData&&i._updateDb(),i._sendAllItemsDownstream();else if("save"===c)i._serverItems.push(b),i._storeItems.splice(i._storeItems.indexOf(a.meta.storeId),1),i._updateDb(),i._sendItemDownstream("server",b);else if("deletePermanently"===c){var d=i._serverItems.indexOf(b),f=i._deletedItems.indexOf(b);i._serverItems.splice(d,1),i._deletedItems.splice(f,1),i._updateDb()}}),i.downStream=new Rx.Subject,i._dbHandler.downStream.subscribe(function(a){i._gotServerData||(i._serverItems=a.data.serverItems),i._storeItems=a.data.storeItems,i._deletedItems=a.data.deletedItems,i._gotDbData=!0,i._gotServerData&&i._updateDb(),i._sendAllItemsDownstream()}),i._filterModelStream=i._model.downStream.filter(function(a){var b=i._serverItems,c=i._storeItems,d=a.meta.serverId,f=a.meta.storeId;return!e.isUndefined(d)&&e.includes(b,d)?!0:!e.isUndefined(f)&&e.includes(c,f)?(e.isUndefined(d)||i._addToServer(d,f),!0):!1}),i._filterModelStream.subscribe(i.downStream),i.upStream=new Rx.Subject,i.upStream.subscribe(function(a){var b=i._serverItems,c=i._storeItems,d=a.meta.serverId,f=a.meta.storeId,g=a.meta.action;switch(g){case"save":e.isUndefined(d)||e.includes(b,d)?!e.isUndefined(d)||e.isUndefined(f)||e.includes(c,f)||(i._storeItems.push(f),i._updateDb()):i._addToServer(d,f);break;case"delete":!e.isUndefined(d)&&e.includes(b,d)?i._removeFromServer(d):!e.isUndefined(f)&&e.includes(c,f)&&(i._storeItems.splice(c.indexOf(f),1),i._updateDb())}}),i._serverItems=[],i._storeItems=[],i._deletedItems=[],i._dbHandler.getEntry(g.meta._storeId),i._serverHandler.fetch()};return g.prototype._updateDb=function(){this._dbHandler.upStream.onNext({meta:{storeId:this.getParent().meta.storeId},data:{storeItems:e.clone(this._storeItems),serverItems:e.clone(this._serverItems),deletedItems:e.clone(this._deletedItems)}})},g.prototype._sendItemDownstream=function(a,b){var c=this._model["_"+a+"IdHash"][b];e.isUndefined(c)||this.downStream.onNext({meta:e.clone(c.meta),data:e.clone(c.data)})},g.prototype._sendAllItemsDownstream=function(){var a,b=e.difference(this._serverItems,this._deletedItems);for(a=0;a<b.length;a++)this._sendItemDownstream("server",b[a]);for(a=0;a<this._storeItems.length;a++)this._sendItemDownstream("store",b[a])},g.prototype._addToServer=function(a,b){var c=this._storeItems;e.isUndefined(b)||e.includes(c,b)||c.push(b),this._serverHandler.upStream.onNext({meta:{storeId:b,serverId:a,action:"save"}})},g.prototype._removeFromServer=function(a){this._storeItems;this._deletedItems.push(a),this._serverHandler.upStream.onNext({meta:{serverId:a,action:"delete"}}),this._updateDb()},g.prototype.getFullRoute=function(){return this.getParent().getFullRoute().concat([this._options.route])},g.prototype.getNextRuntimeId=function(){return this._model.getNextRuntimeId()},g.prototype.getItem=function(a){var b=this._model.getItem(a);return e.includes(this._serverItems,b.meta.serverId)||e.includes(this._storeItems,b.meta.storeId)?b:void 0},g.prototype.getItems=function(a){var b,c;for(c=0;c<this._serverItems.length;c++)b=this._model._serverIdHash[this._serverItems[c]],e.isUndefined(b)||a(b);for(c=0;c<this._storeItems.length;c++)b=this._model._storeIdHash[this._storeItems[c]],e.isUndefined(b)||a(b)},g}),c("ModelItem",["SubModel","rx","lodash"],function(a,b,c){function d(a,b,c){var d=b.filter(function(a){return a.meta.action===c});a["_"+c+"StreamSub"]=d.subscribe(function(b){a[c](b)})}var e=function(e,f,g){var h=this;h.data=f||{},h.meta=g||{},h.subData={};for(var i in e._subModelsSchema)e._subModelsSchema.hasOwnProperty(i)&&(h.subData[i]=new a(i,h));h.meta.rtId=h.meta.rtId||e.getNextRuntimeId();var j=function(a){return a.meta.rtId===h.meta.rtId&&!h.meta.deleted};h._dbDownStream=e._dbDownStream.filter(j),h._updateStreams=b.Observable.merge(e.upStream,e._existingItemDownStream).filter(j),h.getModel=function(){return e},e._rtIdHash[h.meta.rtId]=h,c.isUndefined(h.meta.serverId)||(e._serverIdHash[h.meta.serverId]=h),c.isUndefined(h.meta.storeId)||(e._storeIdHash[h.meta.storeId]=h),d(h,h._dbDownStream,"deletePermanently"),d(h,h._updateStreams,"save"),d(h,h._updateStreams,"delete");var k=c.clone(h.meta);return k.action="save",e.downStream.onNext({meta:k,data:c.clone(h.data)}),h};return e.prototype.getUrl=function(){var a=this.meta.serverId||"";return this.getModel().getUrl()+"/"+a},e.prototype.save=function(a){return this.meta=c.clone(a.meta),delete this.meta.action,this.data=c.clone(a.data),a},e.prototype["delete"]=function(){this.meta.deleted=!0},e.prototype.deletePermanently=function(){var a=this.getModel();delete a._rtIdHash[this.meta.rtId],c.isUndefined(this.meta.serverId)||delete a._serverIdHash[this.meta.serverId],c.isUndefined(this.meta.storeId)||delete a._storeIdHash[this.meta.storeId],this._deletePermanentlyStreamSub.dispose(),this._deleteStreamSub.dispose(),this._saveStreamSub.dispose()},e}),c("Model",["harmonizedData","ModelItem","ServerHandler","dbHandlerFactory","lodash"],function(a,b,c,d,e){function f(a,b,c){e.isUndefined(a[b])&&(a[b]=c[b])}function g(a){return function(b){var c=a._rtIdHash[b.meta.rtId]||a._serverIdHash[b.meta.serverId]||a._storeIdHash[b.meta.storeId];if(!e.isUndefined(c)){c.meta.rtId=c.meta.rtId||b.meta.rtId,c.meta.serverId=c.meta.serverId||b.meta.serverId,c.meta.storeId=c.meta.storeId||b.meta.storeId,c.meta.deleted=b.meta.deleted||c.meta.deleted;var d=b.meta.action;e.extend(b.meta,c.meta),b.meta.action=d,!e.isUndefined(b.meta.serverId)&&e.isUndefined(a._serverIdHash[b.meta.serverId])&&(a._serverIdHash[b.meta.serverId]=c),!e.isUndefined(b.meta.storeId)&&e.isUndefined(a._storeIdHash[b.meta.storeId])&&(a._storeIdHash[b.meta.storeId]=c)}return b}}var h=function(d,h){var i=this;i._modelName=d,i._options=h||{};var j=a._modelSchema[d],k=i._options;for(var l in j)j.hasOwnProperty(l)&&f(k,l,j);return i._subModelsSchema=j.subModels,i._serverHandler=new c(i.getFullRoute(),k.keys,k.serverOptions),k.saveLocally?i._buildDbHandler():i._buildDbHandlerStub(),i._serverDownStream=i._serverHandler.downStream.map(g(i,"server")),i._dbDownStream=i._dbHandler.downStream.map(g(i,"database")),i._serverDownStream.subscribe(i._dbHandler.upStream),i.upStream=new Rx.Subject,i.upStream.filter(function(a){return e.isUndefined(i._rtIdHash[a.meta.rtId])}).subscribe(function(a){new b(i,a.data,a.meta)}),i.upStream.subscribe(i._serverHandler.upStream),i.upStream.subscribe(i._dbHandler.upStream),i.downStream=new Rx.Subject,i._downStream=Rx.Observable.merge(i._serverDownStream,i._dbDownStream),i._existingItemDownStream=i._downStream.filter(function(a){return!e.isUndefined(a.meta.rtId)}),i._existingItemDownStream.subscribe(i.downStream),i._downStream.filter(function(a){return e.isUndefined(a.meta.rtId)}).subscribe(function(a){i._createNewItem(a)}),i._rtIdHash={},i._serverIdHash={},i._storeIdHash={},i._nextRuntimeId=1,i};return h.prototype._createNewItem=function(a){var c=new b(this,a.data,a.meta);a.meta=e.clone(c.meta),delete a.meta.action},h.prototype._buildDbHandler=function(){var a=this;a._dbHandler=d.createDbHandler(a._options.storeName,a._options.keys),d._DbHandler._connectionStream.subscribe(function(b){b===!0&&a._dbHandler.getAllEntries(function(){a._dbReadyCb()})}),null!==d._DbHandler._db&&a._dbHandler.getAllEntries(function(){a._dbReadyCb()})},h.prototype._buildDbHandlerStub=function(){this._dbHandler={downStream:new Rx.Subject,upStream:new Rx.Subject},this._dbHandler.upStream.map(function(a){return a.meta.action="delete"===a.meta.action?"deletePermanently":a.meta.action,a}).subscribe(this._dbHandler.downStream),this._dbReadyCb()},h.prototype.getItems=function(a){var b=this._rtIdHash;for(var c in b)a(b[c])},h.prototype.getItem=function(a){return this._rtIdHash[a]},h.prototype._dbReadyCb=function(){var b=this;a._config.fetchAtStart&&b.getFromServer(function(){b.pushChanges()})},h.prototype.pushChanges=function(){for(var a in this._storeIdHash)if(this._storeIdHash.hasOwnProperty(a)){var b=this._storeIdHash[a],c=e.clone(b.meta),d=e.clone(b.data);e.isUndefined(b.meta.serverId)?(delete c.serverId,c.action="save",this._serverHandler.upStream.onNext({meta:c,data:d})):b.meta.deleted&&(c.action="delete",this._serverHandler.upStream.onNext({meta:c,data:d}))}},h.prototype.getFromServer=function(a){this._serverHandler.fetch(a)},h.prototype.checkForDeletedItems=function(){var a=this;this._serverHandler.sendHttpRequest({params:{view:"keys"}}).then(function(b){var c=[];for(var d in a._serverIdHash)a._serverIdHash.hasOwnProperty(d)&&c.push(parseInt(d));for(var f=e.difference(c,b),g=(a._options.keys,0);g<f.length;g++){var h=a._serverIdHash[f[g]],i={meta:e.clone(h.meta),data:e.clone(h.data)};i.meta.action="deletePermanently",a.downStream.onNext(i),a._dbHandler.upStream.onNext(i)}})},h.prototype.getNextRuntimeId=function(){return this._nextRuntimeId++},h.prototype.getFullRoute=function(){return[this._options.baseUrl,this._options.route]},h}),c("modelHandler",["Model","harmonizedData","dbHandlerFactory","lodash"],function(a,b,c,d){var e={init:function(){var c;for(var f in b._modelSchema)c=d.clone(b._modelSchema[f]),delete c.subModels,e._modelList[f]=new a(f,c)},destroy:function(){e._modelList={},c._DbHandler.deleteDb()},getModel:function(a){return e._modelList[a]},pushAll:function(){var a=e._modelList;for(var b in a)a[b]._serverHandler.pushAll()},getFromServer:function(){var a=e._modelList;for(var b in a)a[b].getFromServer()},_modelList:{}};return e}),c("ViewItem",["lodash","rx","ViewCollection","harmonizedData"],function(a,b,c,d){var e=function(b,c,e,f,g){var h=this;h._wasAlreadySynced=null!==f&&void 0!==f,h.getCollection=function(){return b},h._streams={},h._streams.upStream=b.upStream,h._streams.saveDownStream=b.downStream.filter(function(a){return a.meta.rtId===h._meta.rtId&&"save"===a.meta.action}),h._streams.saveDownStreamSub=h._streams.saveDownStream.subscribe(function(a){h._save(a.data,a.meta)}),h._streams.deleteDownStream=b.downStream.filter(function(a){return a.meta.rtId===h._meta.rtId&&("delete"===a.meta.action||"deletePermanently"===a.meta.action)}),h._streams.deleteDownStreamSub=h._streams.deleteDownStream.subscribe(function(){h._delete()}),h._meta=e||{},h._meta=a.clone(h._meta),delete h._meta.action;for(var i in c)h[i]=c[i];null!==f&&void 0!==f&&h._addSubCollections(f),h._meta.addedToCollection=!1,g&&!a.isUndefined(h._meta.rtId)&&(h._meta.addedToCollection=!0,b.push(h),b._items[h._meta.rtId]=h,d._viewUpdateCb())};return e.prototype._sendItemToUpStream=function(b,c){var e={},f={};if(a.isUndefined(this._meta.rtId)&&(this._meta.rtId=this.getCollection()._model.getNextRuntimeId()),this._meta.addedToCollection===!1){this._meta.addedToCollection=!0;var g=this.getCollection();g.push(this),g._items[this._meta.rtId]=this,d._viewUpdateCb()}if(f.rtId=this._meta.rtId,a.isUndefined(this._meta.serverId)||(f.serverId=this._meta.serverId),a.isUndefined(this._meta.storeId)||(f.storeId=this._meta.storeId),f.action=b,a.isObject(c))e=c;else for(var h in this)this._isPropertyData(h)&&(e[h]=this[h]);this._streams.upStream.onNext({data:e,meta:f})},e.prototype.save=function(){this._sendItemToUpStream("save")},e.prototype._save=function(b,c){a.isUndefined(c.storeId)||(this._meta.storeId=c.storeId),a.isUndefined(c.serverId)||(this._meta.serverId=c.serverId);for(var e in this)this._isPropertyData(e)&&delete this[e];for(var f in b)this[f]=b[f];if(!this._wasAlreadySynced){var g=this.getCollection()._model,h=g.getItem(this._meta.rtId),i=h.subData;this._addSubCollections(i),this._wasAlreadySynced=!0}d._viewUpdateCb()},e.prototype["delete"]=function(){this._sendItemToUpStream("delete"),this._delete()},e.prototype._delete=function(){if(this._meta.deleted=!0,this._meta.addedToCollection)for(var a=this.getCollection(),b=a.length-1;b>=0;b--)a[b]===this&&a.splice(b,1);this._streams.saveDownStreamSub.dispose(),this._streams.deleteDownStreamSub.dispose(),d._viewUpdateCb()},e.prototype.reset=function(){this.getCollection()._model.getItem(this._meta.rtId)},e.prototype._isPropertyData=function(b){return this.hasOwnProperty(b)&&"_meta"!==b&&"getCollection"!==b&&"_streams"!==b&&"_wasAlreadySynced"!==b&&!a.includes(this._subDataList,b)},e.prototype._addSubCollections=function(a){this._subDataList=Object.keys(a);for(var b in a)a.hasOwnProperty(b)&&(this[b]=new c(a[b]))},e.prototype.callFn=function(a,b){this._sendItemToUpStream("function",{fnName:a,fnArgs:b})},e}),c("ViewCollection",["ViewItem","rx","lodash"],function(a,b,c){var d=function e(d,f,g){var h=Object.create(Array.prototype);return h=Array.apply(h),h._model=d,h._items={},h._mapDownFn=f||function(a){return a},h._mapUpFn=g||function(a){return a},h.downStream=d.downStream.filter(function(a){return"function"!==a.meta.action}).map(function(a){var b=c.clone(a);return b.data=h._mapDownFn(b.data),b}),h.downStream.filter(function(a){return c.isUndefined(h._items[a.meta.rtId])&&!a.meta.deleted}).subscribe(function(b){var c=h._model._rtIdHash[b.meta.rtId].subData;new a(h,b.data,b.meta,c,!0)}),h.upStream=new b.Subject,h.upStream.map(function(a){var b=c.clone(a);return b.data=h._mapUpFn(b.data),b}).subscribe(d.upStream),e.injectClassMethods(h),d.getItems(function(b){new a(h,b.data,b.meta,null,!0)}),h.functionReturnStream=d.downStream.filter(function(a){return"function"===a.meta.action}),h};return d.injectClassMethods=function(a){for(var b in d.prototype)d.prototype.hasOwnProperty(b)&&(a[b]=d.prototype[b]);return a},d.prototype.addItem=function(b){var d,e=this._model.getItem(b);if(!c.isUndefined(e)){var f=this._mapDownFn(c.clone(e.data));d=new a(this,f,c.clone(e.meta),e.subData,!0)}return d},d.prototype.fetch=function(){this._model.getFromServer()},d.prototype["new"]=function(){return new a(this,{},{},null)},d.prototype.callFn=function(a,b){this.upStream.onNext({meta:{action:"function"},data:{fnName:a,fnArgs:b}})},d}),c("harmonized",["harmonizedData","modelHandler","ServerHandler","ViewCollection"],function(a,b,c,d){var e={setModelSchema:function(b){a.setModelSchema(b)},setup:function(b,c){a._httpFunction=b,_.isFunction(c)&&(a._viewUpdateCb=c)},setConfig:function(b){_.isObject(b)&&_.extend(a._config,b)},build:function(){b.init()},destroy:function(){b.destroy()},pushAll:function(){b.pushAll()},getFromServer:function(){b.getFromServer()},setOnline:function(){c.connectionStream.onNext(!0)},setOffline:function(){c.connectionStream.onNext(!1)},createViewModel:function(a,c,e){var f=b.getModel(a);return new d(f,c,e)},errorStream:c.errorStream};return e}),b(["harmonized"]),c("lodash",function(){return _}),c("rx",function(){return Rx}),window.harmonized=b("harmonized")});