"use strict";var Harmonized={};Harmonized._config={defaultKeys:{serverKey:"id",storeKey:"_id"},baseUrl:null,dbName:"harmonizedDb",sendModifiedSince:!1},Harmonized._resourceSchema={},Harmonized._httpFunction=function(){throw new Error("No http function was added")},Harmonized.dbVersion=1,Harmonized.setModelSchema=function(a){Harmonized._setModelSchema(a),Harmonized._modelSchema=a},Harmonized.getModelSchema=function(){return Harmonized._modelSchema},Harmonized._setModelSchema=function(a,b){var c,d,e;for(var f in a)d=a[f],_.isObject(d.keys)?(e=d.keys,_.isUndefined(e.serverKey)&&(e.serverKey=Harmonized._config.defaultKeys.serverKey),_.isUndefined(e.storeKey)&&(e.storeKey=Harmonized._config.defaultKeys.storeKey)):d.keys=Harmonized._config.defaultKeys,_.isUndefined(d.storeName)&&(_.isString(b)||(b=""),d.storeName=b+f),c=d.subModels,_.isObject(c)&&Harmonized._setModelSchema(c,d.storeName+"_")},Harmonized.getDbSchema=function(){var a={};return Harmonized._getDbSchema(Harmonized._modelSchema,a),a},Harmonized._getDbSchema=function(a,b){var c,d;for(var e in a)c=a[e],b[c.storeName]=c.keys,d=a[e].subModels,_.isObject(d)&&Harmonized._getDbSchema(d,b)},Harmonized._createStreamItem=function(a,b){a=_.clone(a);var c={meta:{storeId:a[b.storeKey],serverId:a[b.serverKey]}};return delete a[b.storeKey],delete a[b.serverKey],c.data=a,c},Harmonized.getWebStorage=function(){return Harmonized._webStorage},Harmonized._getLocalStorage=function(){return window.localStorage},Harmonized._getSessionStorage=function(){return window.sessionStorage},Harmonized._webStorage=Harmonized._getSessionStorage(),Harmonized.setWebStorage=function(a,b){switch(b&&Harmonized._webStorage.clear(),a){case"session":Harmonized._webStorage=Harmonized._getSessionStorage();break;case"local":Harmonized._webStorage=Harmonized._getLocalStorage();break;default:Harmonized._webStorage=Harmonized._getSessionStorage()}},Harmonized.DbHandler=function(a,b,c){this._storeName=b,this._keys=c,this.downstream=new Rx.Subject,this.upstream=new Rx.Subject,this._upstream=this.upstream.pausableBuffered(a._connectionStream),a._db||a._isConnecting!==!1||(a._connectionStream.onNext(!1),a.connect()),this._saveUpstream=this._upstream.filter(function(a){return"save"===a.meta.action}),this._saveDownstream=this._saveUpstream.map(this.put),this._saveSubscribe=this._saveDownstream.subscribe(this.downstream),this._deleteUpstream=this._upstream.filter(function(a){return"delete"===a.meta.action}),this._deleteDownstream=this._deleteUpstream.map(this.remove),this._deleteSubscribe=this._deleteDownstream.subscribe(this.downstream),this._metaStorageName="harmonizedMeta_"+this._storeName,this._metadata=Harmonized.getWebStorage().getItem(this._metaStorageName)||{}},Harmonized.DbHandler.prototype.getMetadata=function(){return this._metadata},Harmonized.DbHandler.prototype.setMetadata=function(a,b){this._metadata[a]=b,Harmonized.getWebStorage().setItem(this._metaStorageName,this._metadata)},Harmonized.DbHandler.prototype._createDbItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.storeId)||(b[this._keys.storeKey]=a.meta.storeId),_.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._keys.serverKey]=a.meta.serverId),b},Harmonized.IndexedDbHandler=function(a,b){this._handlerType="IndexedDB",Harmonized.DbHandler.call(this,Harmonized.IndexedDbHandler,a,b)},Harmonized.IndexedDbHandler._connectionStream=new Rx.Subject,Harmonized.IndexedDbHandler._db=null,Harmonized.IndexedDbHandler._isConnecting=!1,Harmonized.IndexedDbHandler.getDbReference=function(){return window.indexedDB},Harmonized.IndexedDbHandler.connect=function(){var a=Harmonized.IndexedDbHandler;if(null!==a._db||a._isConnecting)return void(a._isConnecting=!1);a._isConnecting=!0;var b=a.getDbReference().open("harmonizedDb",Harmonized.dbVersion);return b.onsuccess=function(){a._db=b.result,a._isConnecting=!1,a._connectionStream.onNext(!0)},b.onerror=function(b){a._connectionStream.onError(new Error(b.error.name)),a._isConnecting=!1},b.onupgradeneeded=function(a){var b,c,d=a.result,e=Harmonized.getDbSchema();for(c=d.objectStoreNames.length-1;c>=0;c--)b=d.objectStoreNames[c],d.deleteObjectStore(b);for(var f in e){b=e[f];var g=d.createObjectStore(f,{keyPath:b.storeId,autoIncrement:!0});g.createIndex("serverId",b.serverId,{unique:!0,multiEntry:!1})}},b},Harmonized.IndexedDbHandler.closeConnection=function(){var a=Harmonized.IndexedDbHandler,b=a._db;b&&(b.close(),a._db=null,a._connectionStream.onNext(!1))},Harmonized.IndexedDbHandler.deleteDb=function(){return Harmonized.IndexedDbHandler.closeConnection(),Harmonized.IndexedDbHandler.getDbReference().deleteDatabase("harmonizedDb")},Harmonized.IndexedDbHandler.prototype=Object.create(Harmonized.DbHandler.prototype),Harmonized.IndexedDbHandler.prototype.getAllEntries=function(){var a=this,b=Harmonized.IndexedDbHandler._db.transaction([a._storeName]).objectStore(a._storeName),c=b.openCursor();c.onsuccess=function(b){if(c=b.target.result){var d=c.value;a.downstream.onNext(Harmonized._createStreamItem(d,a._keys)),c["continue"]()}},c.onerror=a.downstream.onError},Harmonized.IndexedDbHandler.prototype.put=function(a){function b(d){if(d&&(_.isUndefined(a[g].meta)&&(a[g].meta={}),a[g].meta.storeId=d.target.result,e.onNext(a[g]),g++),g<a.length){var h=f._createDbItem(a[g]),j=i.put(h);j.onsuccess=b,j.onerror=c}else e.onCompleted()}function c(){g++,b()}var d=Harmonized.IndexedDbHandler,e=new Rx.Subject;if(!d._db)return e.onError(new Error("no database connection established")),e.onCompleted(),e;var f=this,g=0;_.isArray(a)||(a=[a]);var h=d._db.transaction([f._storeName],"readwrite");h.onerror=function(a){e.onError(new Error(a.error.name))};var i=h.objectStore(f._storeName);return b(),e},Harmonized.IndexedDbHandler.prototype.remove=function(a){var b=Harmonized.IndexedDbHandler,c=this,d=new Rx.Subject;if(!b._db)return d.onError(new Error("no database connection established")),d.onCompleted(),d;var e=b._db.transaction([c._storeName],"readwrite").objectStore(c._storeName)["delete"](a.meta.storeId);return e.onsuccess=function(){a.meta.deleted=!0,d.onNext(a),d.onCompleted()},e.onerror=d.onError,d},Harmonized.WebSqlHandler=function(){},Harmonized.dbHandlerFactory=function(){Harmonized.dbHandlerFactory._DbHandler=Harmonized.dbHandlerFactory._getIndexedDb()?Harmonized.IndexedDbHandler:Harmonized.dbHandlerFactory._getWebSql()?Harmonized.WebSqlHandler:void 0},Harmonized.dbHandlerFactory.createDbHandler=function(a,b){return Harmonized.dbHandlerFactory._DbHandler?new Harmonized.dbHandlerFactory._DbHandler(a,b):void 0},Harmonized.dbHandlerFactory._getDbStructure=function(){return{}},Harmonized.dbHandlerFactory._getIndexedDb=function(){return window.indexedDB&&_.isFunction(Harmonized.IndexedDbHandler)?window.indexedDb:null},Harmonized.dbHandlerFactory._getWebSql=function(){return window.openDatabase&&_.isFunction(Harmonized.WebSqlHandler)?window.openDatabase:null},Harmonized.ServerHandler=function(a,b,c){var d=this;this._baseUrl=a,this._resourcePath=b,this._options=c,this.upStream=new Rx.Subject,this.upStream.subscribe(function(a){d._connected?d._protocol.push(a,d):d._unpushedList[a.meta.rtId]=a}),this.downStream=new Rx.Subject,this.connectionStream=new Rx.Subject,this.connectionStream.subscribe(function(a){d.setConnectionState(a)}),Harmonized.ServerHandler.connectionStream.subscribe(this.connectionStream),this._unpushedList={},this._lastModified=0,this._connectionStream=new Rx.Subject,this._connected=!1,this._protocol=null;var e;e="websocket"===c.protocol?"websocket":"http",this._setProtocol(e)},Harmonized.ServerHandler.connectionStream=new Rx.Subject,Harmonized.ServerHandler.prototype._setProtocol=function(a){function b(a){null!==c._protocol&&c._protocol.disconnect(),c._protocol=a,c._protocol.connect()}var c=this,d=Harmonized.ServerHandler.httpHandler,e=Harmonized.ServerHandler.socketHandler;"http"===a&&this._protocol!==d?b(d):"websocket"===a&&this._protocol!==e&&b(e)},Harmonized.ServerHandler.prototype.fetch=function(){this._protocol.fetch()},Harmonized.ServerHandler.prototype.pushAll=function(){for(var a in this._unpushedList)this.upStream.onNext(this._unpushedList[a]),delete this._unpushedList[a]},Harmonized.ServerHandler.prototype.setConnectionState=function(a){a?(this._connected=!0,this.pushAll()):this._connected=!1},Harmonized.ServerHandler.prototype._createServerItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._options.serverKey]=a.meta.serverId),b},Harmonized.ServerHandler.httpHandler={connect:function(a){a.setConnectionState(!0)},disconnect:function(a){a.setConnectionState(!1)},fetch:function(a){var b={};Harmonized._config.sendModifiedSince&&null!=a._lastModified&&(b.headers={"If-Modified-Since":a._lastModified}),b.url=a._baseUrl+a._resourcePath,b.method="GET",Harmonized._httpFunction(b)},push:function(a,b){var c={};_.isObject(b._options.params)&&(c.params=b._options.params),c.url=b._baseUrl+b._resourcePath,"delete"===a.meta.action&&(c.method="DELETE",c.url=c.url+a.meta.serverId+"/"),"save"===a.meta.action&&(c.data=a.data,_.isUndefined(a.meta.serverId)?c.method="POST":(c.method="PUT",c.url=c.url+a.meta.serverId+"/")),Harmonized._httpFunction(c).then(function(c){a.data=c,b.downStream.onNext(a)})["catch"](function(c){b._unpushedList[a.meta.rtId]=a,b.downStream.onError(c)})}},Harmonized.ServerHandler.socketHandler={connect:function(){},disconnect:function(){},fetch:function(){},push:function(){}};