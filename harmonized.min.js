var requirejs,require,define;!function(a){function b(a,b){return r.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=p.map,q=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,p.nodeIdCompat&&t.test(a[g])&&(a[g]=a[g].replace(t,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||q)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&q&&q[d]&&(i=q[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function d(b,c){return function(){var d=s.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),k.apply(a,d.concat([b,c]))}}function e(a){return function(b){return c(b,a)}}function f(a){return function(b){n[a]=b}}function g(c){if(b(o,c)){var d=o[c];delete o[c],q[c]=!0,j.apply(a,d)}if(!b(n,c)&&!b(q,c))throw new Error("No "+c);return n[c]}function h(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function i(a){return function(){return p&&p.config&&p.config[a]||{}}}var j,k,l,m,n={},o={},p={},q={},r=Object.prototype.hasOwnProperty,s=[].slice,t=/\.js$/;l=function(a,b){var d,f=h(a),i=f[0];return a=f[1],i&&(i=c(i,b),d=g(i)),i?a=d&&d.normalize?d.normalize(a,e(b)):c(a,b):(a=c(a,b),f=h(a),i=f[0],a=f[1],i&&(d=g(i))),{f:i?i+"!"+a:a,n:a,pr:i,p:d}},m={require:function(a){return d(a)},exports:function(a){var b=n[a];return"undefined"!=typeof b?b:n[a]={}},module:function(a){return{id:a,uri:"",exports:n[a],config:i(a)}}},j=function(c,e,h,i){var j,k,p,r,s,t,u=[],v=typeof h;if(i=i||c,"undefined"===v||"function"===v){for(e=!e.length&&h.length?["require","exports","module"]:e,s=0;s<e.length;s+=1)if(r=l(e[s],i),k=r.f,"require"===k)u[s]=m.require(c);else if("exports"===k)u[s]=m.exports(c),t=!0;else if("module"===k)j=u[s]=m.module(c);else if(b(n,k)||b(o,k)||b(q,k))u[s]=g(k);else{if(!r.p)throw new Error(c+" missing "+k);r.p.load(r.n,d(i,!0),f(k),{}),u[s]=n[k]}p=h?h.apply(n[c],u):void 0,c&&(j&&j.exports!==a&&j.exports!==n[c]?n[c]=j.exports:p===a&&t||(n[c]=p))}else c&&(n[c]=h)},requirejs=require=k=function(b,c,d,e,f){if("string"==typeof b)return m[b]?m[b](c):g(l(b,c).f);if(!b.splice){if(p=b,p.deps&&k(p.deps,p.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?j(a,b,c,d):setTimeout(function(){j(a,b,c,d)},4),k},k.config=function(a){return k(a)},requirejs._defined=n,define=function(a,c,d){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");c.splice||(d=c,c=[]),b(n,a)||b(o,a)||(o[a]=[a,c,d])},define.amd={jQuery:!0}}(),define("../bower_components/almond/almond",function(){}),define("harmonizedData",["lodash"],function(a){var b={};return b._config={defaultKeys:{serverKey:"id",storeKey:"_id"},baseUrl:null,dbName:"harmonizedDb",sendModifiedSince:!1,fetchAtStart:!1},b._resourceSchema={},b._httpFunction=function(){throw new Error("No http function was added")},b._viewUpdateCb=function(){},b.dbVersion=1,b.setModelSchema=function(a){b._setModelSchema(a),b._modelSchema=a},b.getModelSchema=function(){return b._modelSchema},b._setModelSchema=function(c,d){var e,f,g;for(var h in c)f=c[h],a.isObject(f.keys)?(g=f.keys,a.isUndefined(g.serverKey)&&(g.serverKey=b._config.defaultKeys.serverKey),a.isUndefined(g.storeKey)&&(g.storeKey=b._config.defaultKeys.storeKey)):f.keys=b._config.defaultKeys,a.isUndefined(f.storeName)&&(a.isString(d)||(d=""),f.storeName=d+h),e=f.subModels,a.isObject(e)&&b._setModelSchema(e,f.storeName+"_")},b.getDbSchema=function(){var a={};return b._getDbSchema(b._modelSchema,a),a},b._getDbSchema=function(c,d){var e,f;for(var g in c)e=c[g],d[e.storeName]=e.keys,f=c[g].subModels,a.isObject(f)&&b._getDbSchema(f,d)},b._createStreamItem=function(b,c){b=a.clone(b);var d={meta:{storeId:b[c.storeKey],serverId:b[c.serverKey]}};return a.isUndefined(c.storeKey)&&delete d.meta.storeId,delete b[c.storeKey],delete b[c.serverKey],d.data=b,d},b}),define("ServerHandler/httpHandler",["harmonizedData"],function(a){return{connect:function(a){a._connected=!0,a.pushAll()},disconnect:function(a){a._connected=!1},fetch:function(b){var c={};_.isObject(b._options.params)&&(c.params=b._options.params),a._config.sendModifiedSince&&b._lastModified>0&&(c.headers={"If-Modified-Since":b._lastModified}),c.url=b._fullUrl,c.method="GET",a._httpFunction(c).then(function(c){b._lastModified=c.header.lastModified;for(var d=c.data,e=d.length,f=0;e>f;f++){var g=a._createStreamItem(d[f],{serverKey:b._options.serverKey});b.downStream.onNext(g)}})["catch"](function(a){b.downStream.onError(a)})},sendRequest:function(b,c){return b.url=c._fullUrl,b.method=b.method||"GET",a._httpFunction(b)},push:function(b,c){var d={};_.isObject(c._options.params)&&(d.params=c._options.params),d.url=c._fullUrl,"delete"===b.meta.action&&(d.method="DELETE",d.url=d.url+b.meta.serverId+"/"),"save"===b.meta.action&&(d.data=b.data,_.isUndefined(b.meta.serverId)?d.method="POST":(d.method="PUT",d.url=d.url+b.meta.serverId+"/")),a._httpFunction(d).then(function(a){b.data=a,"delete"===b.meta.action&&(b.meta.action="deletePermanently"),c.downStream.onNext(b)})["catch"](function(a){c._unpushedList[b.meta.rtId]=b,c.downStream.onError(a)})}}}),define("ServerHandler/socketHandler",["harmonizedData"],function(){return{connect:function(){},disconnect:function(){},fetch:function(){},push:function(){}}}),define("helper/webStorage",[],function(){var a={};return a.getWebStorage=function(){return a._webStorage},a._getLocalStorage=function(){return window.localStorage},a._getSessionStorage=function(){return window.sessionStorage},a._webStorage=a._getSessionStorage(),a.setWebStorage=function(b,c){switch(c&&a._webStorage.clear(),b){case"session":a._webStorage=a._getSessionStorage();break;case"local":a._webStorage=a._getLocalStorage();break;default:a._webStorage=a._getSessionStorage()}},a}),define("ServerHandler",["ServerHandler/httpHandler","ServerHandler/socketHandler","helper/webStorage","rx"],function(a,b,c,d){var e=function(a,b){var f=this;this._baseUrl=a.splice(0,1)[0],this._resourcePath=a,this._fullUrl=this._buildUrl(),this._options=b,this.upStream=new d.Subject,this.upStream.subscribe(function(a){f._connected?f._protocol.push(a,f):f._unpushedList[a.meta.rtId]=a}),this.downStream=new d.Subject,this.downStream.subscribe(function(){},function(a){e.errorStream.onNext(a)}),this.connectionStream=new d.Subject,this.connectionStream.subscribe(function(a){f.setConnectionState(a)}),this._connected=!1,e.connectionStream.subscribe(this.connectionStream),this._unpushedList={},this._lastModified=c.getWebStorage().getItem("harmonized_modified_"+this._options.modelName)||0,this._protocol=null;var g;g="websocket"===b.protocol?"websocket":"http",this._setProtocol(g)};return e.connectionStream=new d.Subject,e.errorStream=new d.Subject,e.prototype._setProtocol=function(c){function d(a){null!==e._protocol&&e._protocol.disconnect(),e._protocol=a,e._protocol.connect()}var e=this;"http"===c&&this._protocol!==a?d(a):"websocket"===c&&this._protocol!==b&&d(b)},e.prototype.fetch=function(){this._protocol.fetch(this)},e.prototype.sendHttpRequest=function(b){return a.sendRequest(b,this)},e.prototype.pushAll=function(){for(var a in this._unpushedList)this.upStream.onNext(this._unpushedList[a]),delete this._unpushedList[a]},e.prototype.setConnectionState=function(a){this._connected!==a&&(a?this._protocol.connect(this):this._protocol.disconnect(this))},e.prototype._createServerItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._options.serverKey]=a.meta.serverId),b},e.prototype._buildUrl=function(){for(var a=this._baseUrl+"/",b=0;b<this._resourcePath.length;b++)a=a+this._resourcePath[b]+"/";return a},e.prototype.setLastModified=function(a){this._lastModified=a,c.getWebStorage().setItem("harmonized_modified_"+this._options.modelName,a)},e}),define("DbHandler/BaseHandler",["helper/webStorage"],function(a){var b=function(b,c,d){this._storeName=c,this._keys=d,this.downstream=new Rx.Subject,this.upstream=new Rx.Subject,this._upstream=this.upstream.pausableBuffered(b._connectionStream),b._db||b._isConnecting!==!1||(b._connectionStream.onNext(!1),b.connect()),this._saveUpstream=this._upstream.filter(function(a){return"save"===a.meta.action}),this._saveDownstream=this._saveUpstream.map(this.put),this._saveSubscribe=this._saveDownstream.subscribe(this.downstream),this._deleteUpstream=this._upstream.filter(function(a){return"delete"===a.meta.action}),this._deletePermanentlyUpstream=this._upstream.filter(function(a){return"deletePermanently"===a.meta.action}),this._deleteDownstream=this._deleteUpstream.map(this.put),this._deleteSubscribe=this._deleteDownstream.subscribe(this.downstream),this._deletePermanentlyDownstream=this._deletePermanentlyUpstream.map(this.remove),this._deletePermanentlySubscribe=this._deletePermanentlyDownstream.subscribe(this.downstream),this._metaStorageName="harmonizedMeta_"+this._storeName,this._metadata=a.getWebStorage().getItem(this._metaStorageName)||{}};return b.prototype.getMetadata=function(){return this._metadata},b.prototype.setMetadata=function(b,c){this._metadata[b]=c,a.getWebStorage().setItem(this._metaStorageName,this._metadata)},b.prototype._createDbItem=function(a){var b=_.clone(a.data);return _.isUndefined(a.meta)||_.isUndefined(a.meta.storeId)||(b[this._keys.storeKey]=a.meta.storeId),_.isUndefined(a.meta)||_.isUndefined(a.meta.serverId)||(b[this._keys.serverKey]=a.meta.serverId),b._deleted=_.isUndefined(a.meta)||"delete"!==a.meta.action?!1:!0,b},b}),define("DbHandler/IndexedDbHandler",["DbHandler/BaseHandler","harmonizedData","rx"],function(a,b,c){var d=function e(b,c){this._handlerType="IndexedDB",a.call(this,e,b,c)};return d._connectionStream=new c.Subject,d._db=null,d._isConnecting=!1,d.getDbReference=function(){return window.indexedDB},d.connect=function(){var a=d;if(null!==a._db||a._isConnecting)return void(a._isConnecting=!1);a._isConnecting=!0;var c=a.getDbReference().open("harmonizedDb",b.dbVersion);return c.onsuccess=function(){a._db=c.result,a._isConnecting=!1,a._connectionStream.onNext(!0)},c.onerror=function(b){a._connectionStream.onError(new Error(b.error.name)),a._isConnecting=!1},c.onupgradeneeded=function(a){var c,d,e=a.result,f=b.getDbSchema();for(d=e.objectStoreNames.length-1;d>=0;d--)c=e.objectStoreNames[d],e.deleteObjectStore(c);for(var g in f){c=f[g];var h=e.createObjectStore(g,{keyPath:c.storeId,autoIncrement:!0});h.createIndex("serverId",c.serverId,{unique:!0,multiEntry:!1})}},c},d.closeConnection=function(){var a=d,b=a._db;b&&(b.close(),a._db=null,a._connectionStream.onNext(!1))},d.deleteDb=function(){return d.closeConnection(),d.getDbReference().deleteDatabase("harmonizedDb")},d.prototype=Object.create(a.prototype),d.prototype.getAllEntries=function(){var a=this,c=d._db.transaction([a._storeName]).objectStore(a._storeName),e=c.openCursor();e.onsuccess=function(c){if(e=c.target.result){var d=e.value;a.downstream.onNext(b._createStreamItem(d,a._keys)),e["continue"]()}},e.onerror=a.downstream.onError},d.prototype.put=function(a){function b(c){if(c&&(_.isUndefined(a[i].meta)&&(a[i].meta={}),a[i].meta.storeId=c.target.result,g.onNext(a[i]),i++),i<a.length){var d=h._createDbItem(a[i]),f=k.put(d);f.onsuccess=b,f.onerror=e}else g.onCompleted()}function e(){i++,b()}var f=d,g=new c.Subject;if(!f._db)return g.onError(new Error("no database connection established")),g.onCompleted(),g;var h=this,i=0;_.isArray(a)||(a=[a]);var j=f._db.transaction([h._storeName],"readwrite");j.onerror=function(a){g.onError(new Error(a.error.name))};var k=j.objectStore(h._storeName);return b(),g},d.prototype.remove=function(a){var b=d,e=this,f=new c.Subject;if(!b._db)return f.onError(new Error("no database connection established")),f.onCompleted(),f;var g=b._db.transaction([e._storeName],"readwrite").objectStore(e._storeName)["delete"](a.meta.storeId);return g.onsuccess=function(){a.meta.deleted=!0,f.onNext(a),f.onCompleted()},g.onerror=f.onError,f},d}),define("DbHandler/WebSqlHandler",["DbHandler/BaseHandler"],function(){var a=function(){};return a}),define("dbHandlerFactory",["harmonizedData","DbHandler/IndexedDbHandler","DbHandler/WebSqlHandler"],function(a,b,c){var d=function e(){e._DbHandler=e._getIndexedDb()?b:e._getWebSql()?c:void 0};return d.createDbHandler=function(a,b){return d._DbHandler?new d._DbHandler(a,b):void 0},d._getIndexedDb=function(){return window.indexedDB&&_.isFunction(b)?window.indexedDb:null},d._getWebSql=function(){return window.openDatabase&&_.isFunction(c)?window.openDatabase:null},d}),define("SubModel",["harmonizedData","ServerHandler","dbHandlerFactory","modelHandler","lodash"],function(a,b,c,d,e){function f(a,b,c){e.isUndefined(a[b])&&(a[b]=c[b])}var g=function(a,g,h){var i=this;i._modelName=a,i._options=h||{},i.getParent=function(){return g},i._gotServerData=!1,i._gotDbData=!1;var j=g.getModel(),k=j._subModelsSchema[a],l=i._options;f(l,"route",k),f(l,"keys",k),f(l,"storeName",k),i._model=d.getModel(k.sourceModel),e.isUndefined(l.serverOptions)&&(l.serverOptions={}),i._serverHandler=new b(i.getFullRoute(),l.serverOptions),i._dbHandler=c.createDbHandler(l.storeName,l.keys),i._serverHandler.downStream.subscribe(function(a){var b=a.meta.serverId,c=a.meta.action;if(e.isUndefined(b))i._serverItems=a.data,i._gotServerData=!0,i._gotDbData&&i._updateDb(),i._sendAllItemsDownstream();else if("save"===c)i._serverItems.push(b),i._storeItems.splice(i._storeItems.indexOf(a.meta.storeId),1),i._updateDb(),i._sendItemDownstream("server",b);else if("deletePermanently"===c){var d=i._serverItems.indexOf(b),f=i._deletedItems.indexOf(b);i._serverItems.splice(d,1),i._deletedItems.splice(f,1),i._updateDb()}}),i.downStream=new Rx.Subject,i._dbHandler.downStream.subscribe(function(a){i._gotServerData||(i._serverItems=a.data.serverItems),i._storeItems=a.data.storeItems,i._deletedItems=a.data.deletedItems,i._gotDbData=!0,i._gotServerData&&i._updateDb(),i._sendAllItemsDownstream()}),i._filterModelStream=i._model.downStream.filter(function(a){var b=i._serverItems,c=i._storeItems,d=a.meta.serverId,f=a.meta.storeId;return!e.isUndefined(d)&&e.includes(b,d)?!0:!e.isUndefined(f)&&e.includes(c,f)?(e.isUndefined(d)||i._addToServer(d,f),!0):!1}),i._filterModelStream.subscribe(i.downStream),i.upStream=new Rx.Subject,i.upStream.subscribe(function(a){var b=i._serverItems,c=i._storeItems,d=a.meta.serverId,f=a.meta.storeId,g=a.meta.action;switch(g){case"save":e.isUndefined(d)||e.includes(b,d)?!e.isUndefined(d)||e.isUndefined(f)||e.includes(c,f)||(i._storeItems.push(f),i._updateDb()):i._addToServer(d,f);break;case"delete":!e.isUndefined(d)&&e.includes(b,d)?i._removeFromServer(d):!e.isUndefined(f)&&e.includes(c,f)&&(i._storeItems.splice(c.indexOf(f),1),i._updateDb())}}),i._serverItems=[],i._storeItems=[],i._deletedItems=[],i._dbHandler.getEntry(g.meta._storeId),i._serverHandler.fetch()};return g.prototype._updateDb=function(){this._dbHandler.upStream.onNext({meta:{storeId:this.getParent().meta.storeId},data:{storeItems:e.clone(this._storeItems),serverItems:e.clone(this._serverItems),deletedItems:e.clone(this._deletedItems)}})},g.prototype._sendItemDownstream=function(a,b){var c=this._model["_"+a+"IdHash"][b];e.isUndefined(c)||this.downStream.onNext({meta:e.clone(c.meta),data:e.clone(c.data)})},g.prototype._sendAllItemsDownstream=function(){var a,b=e.difference(this._serverItems,this._deletedItems);for(a=0;a<b.length;a++)this._sendItemDownstream("server",b[a]);for(a=0;a<this._storeItems.length;a++)this._sendItemDownstream("store",b[a])},g.prototype._addToServer=function(a,b){var c=this._storeItems;e.isUndefined(b)||e.includes(c,b)||c.push(b),this._serverHandler.upStream.onNext({meta:{storeId:b,serverId:a,action:"save"}})},g.prototype._removeFromServer=function(a){this._storeItems;this._deletedItems.push(a),this._serverHandler.upStream.onNext({meta:{serverId:a,action:"delete"}}),this._updateDb()},g.prototype.getFullRoute=function(){return this.getParent().getFullRoute().concat([this._options.route])},g.prototype.getNextRuntimeId=function(){return this._model.getNextRuntimeId()},g.prototype.getItem=function(a){var b=this._model.getItem(a);return e.includes(this._serverItems,b.meta.serverId)||e.includes(this._storeItems,b.meta.storeId)?b:void 0},g.prototype.getItems=function(a){var b,c;for(c=0;c<this._serverItems.length;c++)b=this._model._serverIdHash[this._serverItems[c]],e.isUndefined(b)||a(b);for(c=0;c<this._storeItems.length;c++)b=this._model._storeIdHash[this._storeItems[c]],e.isUndefined(b)||a(b)},g}),define("ModelItem",["SubModel","rx","lodash"],function(a,b,c){function d(a,b,c){var d=b.filter(function(a){return a.meta.action===c});a["_"+c+"StreamSub"]=d.subscribe(function(b){a[c](b)})}var e=function(e,f,g){var h=this;h.data=f||{},h.meta=g||{},h.subData={};for(var i in e._subModelsSchema)e._subModelsSchema.hasOwnProperty(i)&&(h.subData[i]=new a(i,h));h.meta.rtId=h.meta.rtId||e.getNextRuntimeId();var j=function(a){return a.meta.rtId===h.meta.rtId};h._dbDownStream=e._dbDownStream.filter(j),h._updateStreams=b.Observable.merge(e.upStream,e._existingItemDownStream).filter(j),h.getModel=function(){return e},e._rtIdHash[h.meta.rtId]=h,c.isUndefined(h.meta.serverId)||(e._serverIdHash[h.meta.serverId]=h),c.isUndefined(h.meta.storeId)||(e._storeIdHash[h.meta.storeId]=h),d(h,h._dbDownStream,"deletePermanently"),d(h,h._updateStreams,"save"),d(h,h._updateStreams,"delete");var k=c.clone(h.meta);return k.action="save",e.downStream.onNext({meta:k,data:c.clone(h.data)}),h};return e.prototype.getUrl=function(){var a=this.meta.serverId||"";return this.getModel().getUrl()+"/"+a},e.prototype.save=function(a){return this.meta=c.clone(a.meta),this.data=c.clone(a.data),a},e.prototype["delete"]=function(){this.meta.deleted=!0},e.prototype.deletePermanently=function(){var a=this.getModel();delete a._rtIdHash[this.meta.rtId],c.isUndefined(this.meta.serverId)||delete a._serverIdHash[this.meta.serverId],c.isUndefined(this.meta.storeId)||delete a._storeIdHash[this.meta.storeId],this._deletePermanentlyStreamSub.dispose(),this._deleteStreamSub.dispose(),this._saveStreamSub.dispose()},e}),define("Model",["harmonizedData","ModelItem","ServerHandler","dbHandlerFactory","lodash"],function(a,b,c,d,e){function f(a,b,c){e.isUndefined(a[b])&&(a[b]=c[b])}function g(a){return function(b){var c=a._rtIdHash[b.meta.rtId]||a._serverIdHash[b.meta.serverId]||a._storeIdHash[b.meta.storeId];return e.isUndefined(c)||(c.meta.rtId=c.meta.rtId||b.meta.rtId,c.meta.serverId=c.meta.serverId||b.meta.serverId,c.meta.storeId=c.meta.storeId||b.meta.storeId,b.meta=e.clone(c.meta),!e.isUndefined(b.meta.serverId)&&e.isUndefined(a._serverIdHash[b.meta.serverId])&&(a._serverIdHash[b.meta.serverId]=c),!e.isUndefined(b.meta.storeId)&&e.isUndefined(a._storeIdHash[b.meta.storeId])&&(a._storeIdHash[b.meta.storeId]=c)),b}}var h=function(h,i){var j=this;j._modelName=h,j._options=i||{};var k=a._modelSchema[h],l=j._options;return f(l,"baseUrl",k),f(l,"route",k),f(l,"keys",k),f(l,"storeName",k),j._subModelsSchema=k.subModels,e.isUndefined(l.serverOptions)&&(l.serverOptions={}),j._serverHandler=new c(l.baseUrl,l.route,l.serverOptions),j._dbHandler=d.createDbHandler(l.storeName,l.keys),j._serverDownStream=j._serverHandler.downStream.map(g(j)),j._dbDownStream=j._dbHandler.downStream.map(g(j)),j._serverDownStream.filter(function(a){return!e.isUndefined(a.meta.rtId)}).subscribe(j._dbHandler.upStream),j.upStream=new Rx.Subject,j.upStream.subscribe(j._serverHandler.upStream),j.upStream.subscribe(j._dbHandler.upStream),j.downStream=new Rx.Subject,j._downStream=new Rx.Observable.merge(j._serverDownStream,j._dbDownStream),j._existingItemDownStream=j._downStream.filter(function(a){return!e.isUndefined(a.meta.rtId)}),j._existingItemDownStream.subscribe(j.downStream),j._downStream.filter(function(a){return e.isUndefined(a.meta.rtId)}).subscribe(function(a){var c=new b(j,a.data,a.meta);a.meta=e.clone(c.meta),j.downStream.onNext(a),j.upStream.onNext(a)}),j._rtIdHash={},j._serverIdHash={},j._storeIdHash={},j._nextRuntimeId=1,j._dbHandler.getAllEntries(),j};return h.prototype.getItems=function(a){var b=this._rtIdHash;for(var c in b)a(b[c])},h.prototype.getItem=function(a){return this._rtIdHash[a]},h.prototype.getFromServer=function(){this._serverHandler.fetch()},h.prototype.checkForDeletedItems=function(){var a=this;this._serverHandler.sendHttpRequest({params:{view:"keys"}}).then(function(b){var c=[];for(var d in a._serverIdHash)a._serverIdHash.hasOwnProperty(d)&&c.push(parseInt(d));for(var f=e.difference(c,b),g=(a._options.keys,0);g<f.length;g++){var h=a._serverIdHash[f[g]],i={meta:e.clone(h.meta),data:e.clone(h.data)};i.meta.action="deletePermanently",a.downStream.onNext(i),a._dbHandler.upStream.onNext(i)}})},h.prototype.getNextRuntimeId=function(){return this._nextRuntimeId++},h.prototype.getFullRoute=function(){return[this._options.baseUrl,this._options.route]},h}),define("modelHandler",["Model","harmonizedData","dbHandlerFactory","lodash"],function(a,b,c,d){var e={init:function(){var c;for(var f in b._modelSchema)c=d.clone(b._modelSchema[f]),delete c.subModels,e._modelList[f]=new a(f,c);b._config.fetchAtStart&&e.getFromServer()},destroy:function(){e._modelList={},c._DbHandler.deleteDb()},getModel:function(a){return e._modelList[a]},pushAll:function(){var a=e._modelList;for(var b in a)a[b].pushAll()},getFromServer:function(){var a=e._modelList;for(var b in a)a[b].getFromServer()},_modelList:{}};return e}),define("ViewItem",["lodash","rx","ViewCollection","harmonizedData"],function(a,b,c,d){var e=function(b,c,e,f,g){var h=this;h._wasAlreadySynced=null!==f&&void 0!==f,h.getCollection=function(){return b},h._streams={},h._streams.upStream=b.upStream,h._streams.saveDownStream=b.downStream.filter(function(a){return a.meta.rtId===h._meta.rtId&&"save"===a.meta.action}),h._streams.saveDownStreamSub=h._streams.saveDownStream.subscribe(function(a){h._save(a.data,a.meta)}),h._streams.deleteDownStream=b.downStream.filter(function(a){return a.meta.rtId===h._meta.rtId&&("delete"===a.meta.action||"deletePermanently"===a.meta.action)}),h._streams.deleteDownStreamSub=h._streams.deleteDownStream.subscribe(function(){h._delete()}),h._meta=e||{},h._meta=a.clone(h._meta),delete h._meta.action;for(var i in c)h[i]=c[i];null!==f&&void 0!==f&&h._addSubCollections(f),h._meta.addedToCollection=!1,g&&!a.isUndefined(h._meta.rtId)&&(h._meta.addedToCollection=!0,b.push(h),b._items[h._meta.rtId]=h,d._viewUpdateCb())};return e.prototype._sendItemToUpStream=function(b){var c={},d={};a.isUndefined(this._meta.rtId)&&(this._meta.rtId=this.getCollection()._model.getNextRuntimeId()),d.rtId=this._meta.rtId,a.isUndefined(this._meta.serverId)||(d.serverId=this._meta.serverId),a.isUndefined(this._meta.storeId)||(d.storeId=this._meta.storeId),d.action=b;for(var e in this)this._isPropertyData(e)&&(c[e]=this[e]);this._streams.upStream.onNext({data:c,meta:d})},e.prototype.save=function(){if(this._sendItemToUpStream("save"),!this._meta.addedToCollection){var a=this.getCollection();a.push(this),a._items[this._meta.rtId]=this,this._meta.addedToCollection=!0}},e.prototype._save=function(b,c){a.isUndefined(c.storeId)||(this._meta.storeId=c.storeId),a.isUndefined(c.serverId)||(this._meta.serverId=c.serverId);for(var e in this)this._isPropertyData(e)&&delete this[e];for(var f in b)this[f]=b[f];if(!this._wasAlreadySynced){var g=this.getCollection()._model.getItem(this._meta.rtId).subData;this._addSubCollections(g),this._wasAlreadySynced=!0}d._viewUpdateCb()},e.prototype["delete"]=function(){this._sendItemToUpStream("delete"),this._delete()},e.prototype._delete=function(){if(this._meta.deleted=!0,this._meta.addedToCollection)for(var a=this.getCollection(),b=a.length-1;b>=0;b--)a[b]===this&&a.splice(b,1);this._streams.saveDownStreamSub.dispose(),this._streams.deleteDownStreamSub.dispose(),d._viewUpdateCb()},e.prototype._isPropertyData=function(b){return this.hasOwnProperty(b)&&"_meta"!==b&&"getCollection"!==b&&"_streams"!==b&&"_wasAlreadySynced"!==b&&!a.includes(this._subDataList,b)},e.prototype._addSubCollections=function(a){this._subDataList=Object.keys(a);for(var b in a)a.hasOwnProperty(b)&&(this[b]=new c(a[b]))},e}),define("ViewCollection",["ViewItem","rx","lodash"],function(a,b,c){var d=function e(d,f,g){var h=Object.create(Array.prototype);return h=Array.apply(h),h._model=d,h._items={},h._mapDownFn=f||function(a){return a},h._mapUpFn=g||function(a){return a},h.downStream=d.downStream.map(function(a){var b=c.clone(a);return b.data=h._mapDownFn(b.data),b}),h.downStream.filter(function(a){return c.isUndefined(h._items[a.meta.rtId])}).subscribe(function(b){var c=h._model._rtIdHash[b.meta.rtId].subData;new a(h,b.data,b.meta,c,!0)}),h.upStream=new b.Subject,h.upStream.map(function(a){var b=c.clone(a);return b.data=h._mapUpFn(b.data),b}).subscribe(d.upStream),e.injectClassMethods(h),d.getItems(function(b){new a(h,b.data,b.meta,null,!0)}),h};return d.injectClassMethods=function(a){for(var b in d.prototype)d.prototype.hasOwnProperty(b)&&(a[b]=d.prototype[b]);return a},d.prototype.addItem=function(b){var d,e=this._model.getItem(b);if(!c.isUndefined(e)){var f=this._mapDownFn(c.clone(e.data));d=new a(this,f,c.clone(e.meta),e.subData,!0)}return d},d.prototype.fetch=function(){this._model.getFromServer()},d.prototype["new"]=function(){return new a(this,{},{},null)},d}),define("harmonized",["harmonizedData","modelHandler","ServerHandler","ViewCollection"],function(a,b,c,d){var e={setModelSchema:function(b){a.setModelSchema(b)},setup:function(b,c,d){a._httpFunction=b,_.isObject(c)&&_.extend(a._config,c),_.isFunction(d)&&(a._viewUpdateCb=d)},build:function(){b.init()},destroy:function(){b.destroy()},pushAll:function(){b.pushAll()},getFromServer:function(){b.getFromServer()},setOnline:function(){c.connectionStream.onNext(!0)},setOffline:function(){c.connectionStream.onNext(!1)},createViewModel:function(a,c,e){var f=b.getModel(a);return new d(f,c,e)}};return e}),require(["harmonized"]);